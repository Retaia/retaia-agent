#!/usr/bin/env sh

MSG_FILE="$1"
if [ -z "$MSG_FILE" ] || [ ! -f "$MSG_FILE" ]; then
  echo "commit-msg hook: missing commit message file path."
  exit 1
fi

# First non-empty, non-comment line.
SUBJECT="$(sed -e 's/\r$//' "$MSG_FILE" | awk 'NF && $0 !~ /^#/ { print; exit }')"

if [ -z "$SUBJECT" ]; then
  echo "Empty commit message subject."
  exit 1
fi

PATTERN='^(feat|fix|docs|style|refactor|perf|test|build|ci|chore|revert)(\([a-z0-9._/-]+\))?(!)?: .+$'

echo "$SUBJECT" | grep -Eq "$PATTERN"
if [ $? -ne 0 ]; then
  cat <<'EOF'
Invalid commit message format.
Expected Conventional Commits:
  type(scope?): subject
Allowed types:
  feat, fix, docs, style, refactor, perf, test, build, ci, chore, revert
Examples:
  feat(agent): add device flow retries
  fix: handle expired token on startup
  chore!: drop deprecated auth endpoint
EOF
  exit 1
fi
