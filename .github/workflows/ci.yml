name: CI

on:
  push:
    branches:
      - master
  pull_request:

permissions:
  contents: read
  pull-requests: read

concurrency:
  group: ci-${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  CARGO_HUSKY_DONT_INSTALL_HOOKS: "1"

jobs:
  changes:
    runs-on: ubuntu-latest
    outputs:
      run_tests: ${{ steps.filter.outputs.run_tests }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Detect relevant changes
        id: filter
        uses: dorny/paths-filter@v3
        with:
          filters: |
            run_tests:
              - "Cargo.toml"
              - "Cargo.lock"
              - "src/**"
              - "tests/**"
              - ".cargo-husky/hooks/**"
              - ".github/workflows/ci.yml"

  branch-up-to-date:
    runs-on: ubuntu-latest
    needs: changes
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          submodules: recursive

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Restore Rust cache
        uses: Swatinem/rust-cache@v2
        with:
          shared-key: ci-rust-${{ runner.os }}-${{ hashFiles('**/Cargo.lock') }}

      - name: Ensure branch is up to date and linear
        env:
          GITHUB_EVENT_NAME: ${{ github.event_name }}
          GITHUB_BASE_REF: ${{ github.base_ref }}
          GITHUB_HEAD_REF: ${{ github.head_ref }}
        run: cargo run --quiet --bin check_branch_up_to_date

  commitlint:
    runs-on: ubuntu-latest
    needs: branch-up-to-date
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Validate commit messages (PR range)
        env:
          GITHUB_EVENT_NAME: ${{ github.event_name }}
          GITHUB_BASE_REF: ${{ github.base_ref }}
          GITHUB_SHA: ${{ github.sha }}
        run: |
          if [ "$GITHUB_EVENT_NAME" != "pull_request" ]; then
            echo "Skipping commitlint on non-PR event."
            exit 0
          fi
          git fetch origin "$GITHUB_BASE_REF" --depth=1
          RANGE="origin/$GITHUB_BASE_REF..$GITHUB_SHA"
          PATTERN='^(feat|fix|docs|style|refactor|perf|test|build|ci|chore|revert)(\([a-z0-9._/-]+\))?(!)?: .+'
          FAILED=0
          while IFS= read -r SUBJECT; do
            if [ -z "$SUBJECT" ]; then
              continue
            fi
            if ! printf '%s\n' "$SUBJECT" | grep -Eq "$PATTERN"; then
              echo "Invalid Conventional Commit subject: $SUBJECT"
              FAILED=1
            fi
          done < <(git log --format=%s "$RANGE")
          if [ "$FAILED" -ne 0 ]; then
            echo "Conventional Commits check failed."
            exit 1
          fi

  rust-build-cache:
    runs-on: ubuntu-latest
    if: needs.changes.outputs.run_tests == 'true'
    needs:
      - changes
      - commitlint
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          submodules: recursive

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Restore Rust cache
        uses: Swatinem/rust-cache@v2
        with:
          shared-key: ci-rust-${{ runner.os }}-${{ hashFiles('**/Cargo.lock') }}

      - name: Pre-build test targets
        run: cargo test --tests --no-run

  test-tdd:
    runs-on: ubuntu-latest
    if: needs.changes.outputs.run_tests == 'true'
    needs:
      - changes
      - rust-build-cache
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          submodules: recursive

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Restore Rust cache
        uses: Swatinem/rust-cache@v2
        with:
          shared-key: ci-rust-${{ runner.os }}-${{ hashFiles('**/Cargo.lock') }}
          save-if: false

      - name: Run TDD suite
        run: cargo test --test tdd_runtime

  test-bdd:
    runs-on: ubuntu-latest
    if: needs.changes.outputs.run_tests == 'true'
    needs:
      - changes
      - rust-build-cache
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          submodules: recursive

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Restore Rust cache
        uses: Swatinem/rust-cache@v2
        with:
          shared-key: ci-rust-${{ runner.os }}-${{ hashFiles('**/Cargo.lock') }}
          save-if: false

      - name: Run BDD suite
        run: cargo test --test bdd_specs

  test-e2e:
    runs-on: ubuntu-latest
    if: needs.changes.outputs.run_tests == 'true'
    needs:
      - changes
      - rust-build-cache
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          submodules: recursive

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Restore Rust cache
        uses: Swatinem/rust-cache@v2
        with:
          shared-key: ci-rust-${{ runner.os }}-${{ hashFiles('**/Cargo.lock') }}
          save-if: false

      - name: Run E2E suite
        run: cargo test --test e2e_flow

  coverage-gate:
    runs-on: ubuntu-latest
    if: needs.changes.outputs.run_tests == 'true'
    needs:
      - changes
      - rust-build-cache
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          submodules: recursive

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Restore Rust cache
        uses: Swatinem/rust-cache@v2
        with:
          shared-key: ci-rust-${{ runner.os }}-${{ hashFiles('**/Cargo.lock') }}
          save-if: false

      - name: Install cargo-llvm-cov
        uses: taiki-e/install-action@v2
        with:
          tool: cargo-llvm-cov

      - name: Run coverage gate (min 80%)
        run: |
          mkdir -p coverage
          cargo llvm-cov --workspace --summary-only --json --ignore-filename-regex 'src/bin/' --output-path coverage/llvm-cov-summary.json --test tdd_runtime --test bdd_specs --test e2e_flow
          cargo run --quiet --bin check_coverage -- --file coverage/llvm-cov-summary.json --min 80

      - name: Upload coverage artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          retention-days: 14
          path: |
            coverage/**

  ci-required:
    runs-on: ubuntu-latest
    if: always()
    needs:
      - changes
      - branch-up-to-date
      - commitlint
      - rust-build-cache
      - test-tdd
      - test-bdd
      - test-e2e
      - coverage-gate
    steps:
      - name: Required CI gate
        run: |
          [ "${{ needs.branch-up-to-date.result }}" = "success" ] || exit 1
          [ "${{ needs.commitlint.result }}" = "success" ] || exit 1
          if [ "${{ needs.changes.outputs.run_tests }}" = "true" ]; then
            [ "${{ needs.rust-build-cache.result }}" = "success" ] || exit 1
            [ "${{ needs.test-tdd.result }}" = "success" ] || exit 1
            [ "${{ needs.test-bdd.result }}" = "success" ] || exit 1
            [ "${{ needs.test-e2e.result }}" = "success" ] || exit 1
            [ "${{ needs.coverage-gate.result }}" = "success" ] || exit 1
          else
            [ "${{ needs.rust-build-cache.result }}" = "skipped" ] || exit 1
            [ "${{ needs.test-tdd.result }}" = "skipped" ] || exit 1
            [ "${{ needs.test-bdd.result }}" = "skipped" ] || exit 1
            [ "${{ needs.test-e2e.result }}" = "skipped" ] || exit 1
            [ "${{ needs.coverage-gate.result }}" = "skipped" ] || exit 1
          fi
          echo "All required CI jobs passed."
